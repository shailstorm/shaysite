<!-- <!DOCTYPE html> -->

<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>sudoku ⭑ .ᐟ.ᐟ.ᐟ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Karla:ital,wght@0,200..800;1,200..800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Karla:ital,wght@0,200..800;1,200..800&family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
</head>


<body class="bg-[#FCF6FA]" >
  <div class="relative max-w-full max-h-full p-10 py-10 sm:container sm:mx-auto sm:max-w-2xl">

      <div class="flex flex-row justify-between items-center h-[75px]">
        <h1 class="text-4xl text-[#98D5CE] pt-10 font-['Quicksand'] font-bold">sudoku cafe ⋆˚࿔</h1>
        <div class="relative">
          <img id="menu-icon" src="/sudoku/little-menu.png" alt="options" class="rotate-[4deg] hover:rotate-[10deg] w-[75px] cursor-pointer">
        </div>
      </div>
      
      <div class="flex flex-row justify-between font-['Nunito']">
        <p class="text-[#CECBCE] py-4">click a box, enter a number</p>
        <h3 id="loadingContainer" class="hidden self-end text-lg text-[#FFA467] text-center mb-1">loading ( •̀⤙•́ )</h3>
        <h3 id="victory" class="hidden self-end text-lg text-[#FFA467] text-center mb-1">solved .ᐟ.ᐟ.ᐟ</h3>
      </div>

      <div class="w-full sm:max-w-2xl aspect-square">
        <table id="board" class="w-full h-full bg-[#FFFDFE] font-sans table-fixed"></table>
      </div>

      <div id="expanded-menu" class="hidden absolute inset-0 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 items-center z-40">
        
        <div class="relative">
          <img src="/sudoku/menu.png" alt="Menu" class="w-full">
          <div class="absolute inset-0 flex flex-col items-center justify-center space-y-7 translate-y-[25px] translate-y-[30px] text-sm sm:text-lg">

            <div class="text-[#B9B9E6] font-['Nunito'] rotate-[8deg] flex flex-col justify-center">
              <button id="menu-new-btn" class="">new game</button>
              <!-- hidden buttons for board sizes -->
              <div id="create-size-input-container" class="hidden absolute flex flex-row space-x-2 justify-center top-full left-0 right-0">
                <button id="create-4-btn" class="text-xs px-2 py-1 bg-[#EBEAFF] rounded">4x4</button>
                <button id="create-9-btn" class="text-xs px-2 py-1 bg-[#EBEAFF] rounded">9x9</button>
                <!-- <button id="create-16-btn" class="text-xs px-2 py-1 bg-[#EBEAFF] rounded">16x16</button> -->
              </div>
            </div>
            
            <div class="text-[#FFB597] font-['Nunito'] rotate-[8deg] flex flex-col justify-center">
              <button id="menu-empty-btn" class="">new empty board</button>
              <!-- hidden buttons for board sizes -->
              <div id="size-input-container" class="hidden absolute flex flex-row space-x-2 justify-center top-full left-0 right-0">
                <button id="size-4-btn" class="text-xs px-2 py-1 bg-[#FFE6C9] rounded">4x4</button>
                <button id="size-9-btn" class="text-xs px-2 py-1 bg-[#FFE6C9] rounded">9x9</button>
                <!-- <button id="size-16-btn" class="text-xs px-2 py-1 bg-[#FFE6C9] rounded">16x16</button> -->
              </div>
            </div>

            <div class="text-[#A6CFF9] font-['Nunito'] rotate-[5deg] flex flex-col justify-center">
              <button id="menu-load-btn" class="">load json board</button>
              <!-- hidden file upload for load board -->
              <input id="file-upload" type="file" display="none" accept="json" class="hidden absolute flex flex-row top-full left-0 right-0 cursor-pointer file:text-sm file:text-[#A6CFF9] file:bg-[#FFFFFF] file:rounded-lg file:border-0">
            </div>

            <button id="menu-solve-btn" class="text-[#9BBE96] font-['Nunito'] rotate-[6deg]">run solver</button>

            <button id="menu-clear-btn" class="text-[#FFBBEA] font-['Nunito'] rotate-[9deg]">clear board</button>

          </div>
        </div>
        
      </div>

  </div>
</body>


</html>

<script>
  async function fetch_(loc, body, controller = null) {
    console.log('fetching..?')
    try {
      const options = {
        method: 'POST',
        cache: 'no-cache',
        redirect: 'follow',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body),
      };
      
      if (controller) {
        options.signal = controller.signal;
      }
      
      const res = await fetch(loc, options);
      if (res.ok) {
        return await res.json();
      } else {
        return {error: await response.text()};
      }
    } catch (e) {
      if (e.name === 'AbortError') {
        return {error: 'Request cancelled'};
      }
      return {error: await 'disconnected from server', off: true}
    }
  }

  let selectedCoords = undefined;
  let board;
  let boardTdElts;
  let givenNumbers; // track given numbers
  let N;
  let borderStyling = 'border-2 border-[#DEDADD]';
  let solverController = null;

  function makeBoard(n) {
    console.log(`making ${n}x${n} board`);
    
    // cancel any solver request currently running
    if (solverController) {
      solverController.abort();
      solverController = null;
      stopLoading();
    }

    selectedCoords = undefined; // reset coords after making new board
    
    victoryElt.classList.add('hidden');
    
    const boardElt = document.getElementById('board');
    boardElt.innerHTML = "";
    const [sw, sh] = regionSize(n);
    N = n;

    // js rep for board
    boardTdElts = [];
    board = []
    givenNumbers = []
    for (let i = 0; i < n; i++) {
      board.push([]);
      boardTdElts.push([]);
      givenNumbers.push([]);
      for (let j = 0; j < n; j++) {
        board[i].push(0);
        boardTdElts[i].push(undefined);
        givenNumbers[i].push(false);
      }
    }

    // vertical borders
    for (let j = 0; j < n / sw; j++) {
      const colgroupElt = document.createElement('colgroup');
      colgroupElt.className = borderStyling;
      boardElt.appendChild(colgroupElt);
      for (let k = 0; k < sw; k++) {
        const colElt = document.createElement('col');
        colgroupElt.appendChild(colElt);
      }
    }

    // horizontal borders, fill board
    for (let j = 0; j < n / sh; j++) {
      const tbodyElt = document.createElement('tbody');
      tbodyElt.className = borderStyling;
      boardElt.appendChild(tbodyElt);
      for (let k = 0; k < sh; k++) {
        const trElt = document.createElement('tr');
        tbodyElt.appendChild(trElt);
        for (let p = 0; p < n; p++) {
          const tdElt = document.createElement('td');
          tdElt.className = 'border border-[#DEDADD] text-center p-0 cursor-pointer hover:bg-gray-100 transition-colors duration-100 text-xl font-[\'Nunito\'] text-[#897D9C]';
          const cellSize = Math.floor(400 / n); // 400px is approx the container size
          tdElt.style.width = `${cellSize}px`;
          tdElt.style.height = `${cellSize}px`;
          tdElt.style.minWidth = `${cellSize}px`;
          tdElt.style.minHeight = `${cellSize}px`;
          tdElt.style.maxWidth = `${cellSize}px`;
          tdElt.style.maxHeight = `${cellSize}px`;
          // to show coordinates on each cell:
          // if (n === 4) tdElt.innerText = `${j*sh+k}_${p}`;
          const [r,c] = [j*sh+k, p];
          tdElt.addEventListener('click', () => toggleEltSelect(tdElt, [r,c]));
          trElt.appendChild(tdElt);
          boardTdElts[r][c] = tdElt;
        }
      }
    }
  }

  function regionSize(n) {
    let sn = Math.floor(Math.sqrt(n)) - 1;
    while (n % ++sn != 0 && sn < n) {}
    return [n / sn, sn];
  }

    function coordsEq(c1, c2) {
    return c1 && c2 && c1[0] == c2[0] && c1[1] == c2[1];
  }

  async function generateNewBoard(n) {
    // cancel any solver request currently running
    if (solverController) {
      solverController.abort();
    }
    
    solverController = new AbortController();
    startLoading();
    
    const newPuzzle = await fetch_('/api/generate', {size: n}, solverController);
    
    solverController = null;
    
    if (newPuzzle.error) {
      if (newPuzzle.error === 'Request cancelled') {
        stopLoading();
        return;
      }
      if (newPuzzle.off === true) {
        alert("couldn't communicate with the server");
      } else {
        alert('error generating puzzle');
      }
      stopLoading();
      return;
    }
    stopLoading();
    useBoard(newPuzzle, true); // true means it's a generated puzzle
  }


  function toggleEltSelect(tdElt, coords) {
    if (coordsEq(coords,selectedCoords)) {
      tdElt.classList.remove('bg-[#F1EEFF]');
      tdElt.classList.add('hover:bg-gray-100');
      selectedCoords = undefined;
    }
    else {
      // unselect any prev selected cell
      if (selectedCoords) {
        const [r,c] = selectedCoords;
        boardTdElts[r][c].classList.remove('bg-[#F1EEFF]');
        boardTdElts[r][c].classList.add('hover:bg-gray-100');
      }
      // select the new cell
      tdElt.classList.add('bg-[#F1EEFF]');
      tdElt.classList.remove('hover:bg-gray-100');
      selectedCoords = coords;
    }
  }

  const victoryElt = document.getElementById('victory')
  const loadingElt = document.getElementById('loadingContainer')

  function toggleVictory(val) {
    if (val) {
      victoryElt.classList.remove('hidden');
    } else {
      victoryElt.classList.add('hidden');
    }
  }

  async function victoryCheck(checkCoords) {
    fetch_('/api/victory_check', {board, checkCoords}).then(r => toggleVictory(r.victory === true));
  }

  // options menu
  const menuIcon = document.getElementById('menu-icon');
  const expandedMenu = document.getElementById('expanded-menu');
  const sizeInputContainer = document.getElementById('size-input-container');
  const createSizeInputContainer = document.getElementById('create-size-input-container');
  
  function toggleMenuExpand() {
    expandedMenu.classList.toggle('hidden');
    if (expandedMenu.classList.contains('hidden')) {
      menuIcon.classList.remove('hidden');
    } else {
      menuIcon.classList.add('hidden');
    }
  }
  
  // click anywhere to close dropdown
  document.addEventListener('click', (e) => {
    if (!menuIcon.contains(e.target) && !expandedMenu.contains(e.target)) {
      expandedMenu.classList.add('hidden');
      menuIcon.classList.remove('hidden');
    }
  });
  
  menuIcon.addEventListener('click', toggleMenuExpand);
  
  // menu button handlers
  
  document.getElementById('menu-empty-btn').addEventListener('click', () => {
    sizeInputContainer.classList.toggle('hidden');
    createSizeInputContainer.classList.add('hidden');
    document.getElementById('file-upload').classList.add('hidden');
  });

  document.getElementById('menu-new-btn').addEventListener('click', () => {
    createSizeInputContainer.classList.toggle('hidden');
    sizeInputContainer.classList.add('hidden');
    document.getElementById('file-upload').classList.add('hidden');
  });

  document.getElementById('menu-load-btn').addEventListener('click', () => {
    document.getElementById('file-upload').classList.toggle('hidden');
    sizeInputContainer.classList.add('hidden');
    createSizeInputContainer.classList.add('hidden');
  });
  
  document.getElementById('menu-solve-btn').addEventListener('click', () => {
    toggleMenuExpand();
    runSolver();
  });

  document.getElementById('menu-clear-btn').addEventListener('click', () => {
    toggleMenuExpand();
    clearBoard();
  });

  document.addEventListener('keydown', async (ev) => {
    const key = ev.key;
    
    if (document.activeElement.tagName === 'INPUT') return;
    
    if (selectedCoords && ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(key)) {
      const [r, c] = selectedCoords;
      let newR = r, newC = c;
      
      if (key === 'ArrowUp' && r > 0) newR = r - 1;
      else if (key === 'ArrowDown' && r < N - 1) newR = r + 1;
      else if (key === 'ArrowLeft' && c > 0) newC = c - 1;
      else if (key === 'ArrowRight' && c < N - 1) newC = c + 1;
      
      if (newR !== r || newC !== c) {
        toggleEltSelect(boardTdElts[newR][newC], [newR, newC]);
      }
      return;
    }
    
    if (selectedCoords === undefined) return;
    const [r,c] = selectedCoords;

    if (givenNumbers[r][c]) return;

    if (key === 'Backspace') {
      boardTdElts[r][c].innerText = "";
      board[r][c] = 0;
      return;
    }

    const v = parseInt(key);

    if (isNaN(v) || v > N || v < 0) return
    boardTdElts[r][c].innerText = v == 0 ? "" : v;
    board[r][c] = v;
    await victoryCheck([r, c]);
  })

  function badUpload(reason) {
    console.log('bad');
  }

  const fileElt = document.getElementById('file-upload');
  let loadedBoard = undefined;
  fileElt.addEventListener('change', async (ev) => {
    // parse the JSON and load the level
    const reader = new FileReader();
    const file = ev.target.files[0];

    reader.addEventListener('load', ev => {
      // make a new board
      loadedBoard = JSON.parse(ev.target.result);
      if (!(loadedBoard instanceof Array)) return badUpload('json file must be a 2D array');
      const n = loadedBoard.length;
      // make sure all the values are numbers
      for (let r = 0; r < n; r++)
        for (let c = 0; c < n; c++)
          if (isNaN(loadedBoard[r][c])) return badUpload(`bad element at r=${r},c=${c}`);
      useBoard();
    })
    reader.readAsText(file);
  })

  // uses loadedBoard by default
  function useBoard(newBoard, isGenerated = false, preserveGiven = false) {
    if (newBoard === undefined)
      newBoard = loadedBoard;
    if (!newBoard) return;
    
    if (solverController) {
      solverController.abort();
      solverController = null;
      stopLoading();
    }
    
    const n = newBoard.length;
    
    // don't remake board
    if (preserveGiven && N === n && givenNumbers) {
      for (let r = 0; r < n; r++)
        for (let c = 0; c < n; c++) {
          const v = newBoard[r][c];
          board[r][c] = v;
          boardTdElts[r][c].innerText = v ? v : "";
          
          if (givenNumbers[r][c]) {
            boardTdElts[r][c].classList.add('text-[#574F63]', 'font-bold');
            boardTdElts[r][c].classList.remove('text-[#7A6F8A]');
          }
        }
    } else {
      // create new board
      makeBoard(n);
      // fill board with loaded vals
      for (let r = 0; r < n; r++)
        for (let c = 0; c < n; c++) {
          const v = newBoard[r][c];
          board[r][c] = v;
          boardTdElts[r][c].innerText = v ? v : "";
          
          if (isGenerated && v !== 0) {
            givenNumbers[r][c] = true;
            boardTdElts[r][c].classList.add('text-[#574F63]', 'font-bold');
            boardTdElts[r][c].classList.remove('text-[#7A6F8A]');
          }
        }
    }
    victoryCheck();
  }

  function isPerfectSquare(n){
      for (let i=0; i<=n/2; i++){
          if (Math.pow(i, 2) == n){
              return true;
          }
      }
      return false;
  }

  document.getElementById('size-4-btn').addEventListener('click', () => {
    makeBoard(4);
    toggleMenuExpand();
    sizeInputContainer.classList.add('hidden');
  });

  document.getElementById('size-9-btn').addEventListener('click', () => {
    makeBoard(9);
    toggleMenuExpand();
    sizeInputContainer.classList.add('hidden');
  });

  // document.getElementById('size-16-btn').addEventListener('click', () => {
  //   makeBoard(16);
  //   toggleMenuExpand();
  //   sizeInputContainer.classList.add('hidden');
  // });

  document.getElementById('create-4-btn').addEventListener('click', () => {
    generateNewBoard(4);
    toggleMenuExpand();
    createSizeInputContainer.classList.add('hidden');
  });

  document.getElementById('create-9-btn').addEventListener('click', () => {
    generateNewBoard(9);
    toggleMenuExpand();
    createSizeInputContainer.classList.add('hidden');
  });

  function startLoading() {
    loadingElt.classList.remove('hidden');
    victoryElt.classList.add('hidden');
  }

  function stopLoading() {
    loadingElt.classList.add('hidden');
  }

  function clearBoard() {
    for (let r = 0; r < N; r++) {
      for (let c = 0; c < N; c++) {
        if (!givenNumbers[r][c]) {
          board[r][c] = 0;
          boardTdElts[r][c].innerText = "";
        }
      }
    }
    victoryCheck();
  }

  async function runSolver() {
    // cancel any solver request currently running
    if (solverController) {
      solverController.abort();
    }
    
    solverController = new AbortController();
    startLoading();
    
    const solvedBoard = await fetch_('/api/solve', board, solverController);
    console.log('solved', solvedBoard);
    
    solverController = null;
    
    if (solvedBoard === null){
      alert('no solution found');
      stopLoading();
      return;
    }
    if (solvedBoard.error){
      if (solvedBoard.error === 'Request cancelled') {
        stopLoading();
        return;
      }
      if (solvedBoard.off === true){
        alert("couldn't communicate with the server");
      }else{
        alert('error occurred: ', solvedBoard.error);
      }
      stopLoading();
      return;
    }
    stopLoading();
    useBoard(solvedBoard, false, true); // preserve given numbers
  }

  makeBoard(9)
  generateNewBoard(9);
  stopLoading();

</script>